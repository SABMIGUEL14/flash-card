<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SMARTSTUDYHUP - Préparez vos examens efficacement</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
  /* Reset and base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1e3a8a, #06b6d4);
    color: #f9fafb;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: rgba(15, 23, 42, 0.9);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    position: sticky;
    top: 0;
    z-index: 10;
    flex-wrap: wrap;
  }
  header h1 {
    font-weight: 900;
    font-size: 1.8rem;
    background: linear-gradient(90deg, #8b5cf6, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    user-select: none;
    margin: 0;
    flex-grow: 1;
  }
  .lang-select-wrapper {
    margin-left: 1rem;
    min-width: 160px;
  }
  select#language-selector {
    width: 100%;
    font-size: 1rem;
    padding: 0.5rem 0.6rem;
    border-radius: 8px;
    border: none;
    background: #0f172a;
    color: #d1d5db;
    border: 1.5px solid #0ea5e9;
    cursor: pointer;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
  }
  select#language-selector:focus {
    border-color: #8b5cf6;
    box-shadow: 0 0 8px #8b5cf6aa;
  }
  main {
    flex-grow: 1;
    max-width: 960px;
    margin: 2rem auto;
    width: 90%;
    background: rgba(31, 41, 55, 0.85);
    border-radius: 16px;
    padding: 2rem 2.5rem;
    box-shadow: 0 8px 32px rgba(6,182,212,0.3);
  }
  section {
    margin-bottom: 3rem;
  }
  h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    border-bottom: 2px solid #06b6d4;
    padding-bottom: 0.3rem;
  }
  label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: 600;
  }
  input[type="date"], input[type="file"], button {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    margin-bottom: 1rem;
    outline-offset: 2px;
  }
  input[type="date"], input[type="file"] {
    background: #0f172a;
    color: #d1d5db;
    border: 1.5px solid #0ea5e9;
    transition: border-color 0.3s ease;
  }
  input[type="date"]:focus, input[type="file"]:focus, button:focus {
    border-color: #8b5cf6;
    box-shadow: 0 0 8px #8b5cf6aa;
    outline: none;
  }
  button {
    background: linear-gradient(90deg, #8b5cf6, #06b6d4);
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background-position 0.3s ease;
    background-size: 200% 100%;
    background-position: left;
  }
  button:hover, button:focus {
    background-position: right;
    outline: none;
  }

  /* Revision cards */
  .flashcards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
  }
  .card {
    background: #0f172a;
    border-radius: 16px;
    padding: 1.3rem 1.6rem;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.5);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    position: relative;
    min-height: 130px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
  }
  .card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 32px rgba(6, 182, 212, 0.85);
  }
  .card .front, .card .back {
    font-size: 1.05rem;
    font-weight: 600;
    color: #e0e7ff;
  }
  .card .back {
    display: none;
    color: #a5b4fc;
  }
  .card.flipped .front {
    display: none;
  }
  .card.flipped .back {
    display: block;
  }

  /* Planning style */
  .planning-container {
    background: #0f172a;
    border-radius: 16px;
    padding: 1.4rem 1.8rem;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.7);
    color: #c7d2fe;
  }
  .planning-container ul {
    list-style: none;
    padding-left: 1rem;
  }
  .planning-container ul li {
    margin-bottom: 0.8rem;
    font-weight: 600;
  }

  /* Quiz styles */
  .quiz-container {
    background: #0f172a;
    border-radius: 16px;
    padding: 1.6rem 2rem;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.7);
    color: #e0e7ff;
  }
  .quiz-question {
    font-weight: 700;
    margin-bottom: 1rem;
    font-size: 1.2rem;
  }
  .quiz-options {
    list-style: none;
    padding: 0;
    margin-bottom: 1rem;
  }
  .quiz-options li {
    margin-bottom: 0.8rem;
  }
  .quiz-options label {
    cursor: pointer;
    user-select: none;
  }
  input[type="radio"] {
    margin-right: 0.8rem;
  }
  .btn-quiz-submit {
    background: #8b5cf6;
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 1rem;
    transition: background-color 0.3s ease;
  }
  .btn-quiz-submit:hover, .btn-quiz-submit:focus {
    background: #06b6d4;
    outline: none;
  }
  .quiz-result {
    font-weight: 700;
    font-size: 1rem;
    margin-top: 0.8rem;
  }

  /* Progress chart */
  .progress-container {
    width: 120px;
    height: 120px;
    margin: 1rem auto 2rem auto;
  }
  svg.progress-ring {
    transform: rotate(-90deg);
  }
  .progress-text {
    font-weight: 800;
    font-size: 1.5rem;
    fill: #06b6d4;
    text-anchor: middle;
    dominant-baseline: middle;
  }

  /* Responsive */
  @media (max-width: 640px) {
    main {
      padding: 1.5rem 1.5rem;
    }
    h2 {
      font-size: 1.3rem;
    }
    .card {
      min-height: 110px;
    }
    header {
      justify-content: center;
      gap: 1rem;
    }
    .lang-select-wrapper {
      margin-left: 0;
      min-width: 140px;
      width: 100%;
    }
  }
</style>
<!-- Include pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
<!-- Include mammoth.js for DOCX parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>
<body>
<header>
  <h1>SMARTSTUDYHUP</h1>
  <div class="lang-select-wrapper">
    <select id="language-selector" aria-label="Choisir la langue">
      <option value="fr" selected>Français</option>
      <option value="en">English</option>
      <option value="es">Español</option>
      <option value="la">Latina</option>
    </select>
  </div>
</header>
<main>
  <section aria-label="Préparation examen et insertion fichier cours">
    <h2 id="heading1">1. Entrez la date de votre examen</h2>
    <label for="exam-date" id="labelExamDate">Date de l'examen :</label>
    <input type="date" id="exam-date" aria-required="true" />
    <h2 id="heading2">2. Importez votre fichier de cours (texte, PDF, Word)</h2>
    <label for="course-file" id="labelFile">Choisir un fichier de cours :</label>
    <input type="file" id="course-file" accept=".txt,.pdf,.docx" aria-required="true" />
    <button id="process-course-btn" aria-label="Créer fiches de révision et planning" type="button">Créer fiches et planning</button>
    <p id="file-feedback" role="alert" aria-live="polite"></p>
  </section>

  <section aria-label="Fiches de révisions générées" id="revision-cards-section" hidden>
    <h2 id="headingFlashcards">Fiches de révision</h2>
    <div class="flashcards" id="flashcards-container" tabindex="0" aria-live="polite" aria-atomic="true"></div>
  </section>

  <section aria-label="Planning d'étude personnalisé" id="planning-section" hidden>
    <h2 id="headingPlanning">Planning d'étude</h2>
    <div class="planning-container" id="planning-container" tabindex="0" aria-live="polite" aria-atomic="true"></div>
  </section>

  <section aria-label="Quiz d'apprentissage" id="quiz-section" hidden>
    <h2 id="headingQuiz">Quiz pour améliorer votre apprentissage</h2>
    <div class="progress-container" aria-label="Progression du quiz">
      <svg class="progress-ring" width="120" height="120" aria-hidden="true" role="img" aria-label="Progression du quiz circulaire">
        <circle
          class="progress-ring__circle"
          stroke="#06b6d4"
          stroke-width="8"
          fill="transparent"
          r="52"
          cx="60"
          cy="60" />
        <text x="60" y="65" class="progress-text" id="progress-percent">0%</text>
      </svg>
    </div>
    <div class="quiz-container">
      <div id="quiz-question" class="quiz-question"></div>
      <ul id="quiz-options" class="quiz-options"></ul>
      <button id="submit-quiz" class="btn-quiz-submit" aria-label="Soumettre la réponse du quiz" type="button">Soumettre</button>
      <div id="quiz-result" class="quiz-result" role="alert" aria-live="polite"></div>
    </div>
  </section>
</main>
<script>
(() => {
  const i18n = {
    fr: {
      step1: "1. Entrez la date de votre examen",
      step2: "2. Importez votre fichier de cours (texte, PDF, Word)",
      examDateLabel: "Date de l'examen :",
      chooseFileLabel: "Choisir un fichier de cours :",
      createBtn: "Créer fiches et planning",
      fileEmpty: "Vous devez choisir un fichier de cours au format texte (.txt), PDF ou Word (.docx).",
      dateEmpty: "Vous devez entrer la date de votre examen.",
      fileErrorType: "Format de fichier non supporté. Veuillez utiliser un fichier texte (.txt), PDF ou Word (.docx).",
      fileReadError: "Erreur lors de la lecture du fichier.",
      flashcardsTitle: "Fiches de révision",
      planningTitle: "Planning d'étude",
      quizTitle: "Quiz pour améliorer votre apprentissage",
      cardsNotEnough: "Le fichier ne contient pas assez de contenu pour créer des fiches.",
      planDatePast: "Date de l'examen antérieure ou égale à aujourd'hui.",
      flippedBack: "Voir plus dans le cours.",
      quizCorrect: "Correct !",
      quizWrong: "Faux. La bonne réponse était :",
      progressLabel: "Progression du quiz"
    },
    en: {
      step1: "1. Enter your exam date",
      step2: "2. Upload your course file (text, PDF, Word)",
      examDateLabel: "Exam date:",
      chooseFileLabel: "Choose a course file:",
      createBtn: "Create flashcards and plan",
      fileEmpty: "You must select a course file in text (.txt), PDF, or Word (.docx) format.",
      dateEmpty: "You must enter your exam date.",
      fileErrorType: "Unsupported file format. Please use text (.txt), PDF, or Word (.docx).",
      fileReadError: "Error reading file.",
      flashcardsTitle: "Revision flashcards",
      planningTitle: "Study schedule",
      quizTitle: "Quiz to improve your learning",
      cardsNotEnough: "The file does not contain enough content to create flashcards.",
      planDatePast: "Exam date is in the past or today.",
      flippedBack: "See more in the course.",
      quizCorrect: "Correct!",
      quizWrong: "Wrong. The correct answer was:",
      progressLabel: "Quiz progress"
    },
    es: {
      step1: "1. Introduzca la fecha de su examen",
      step2: "2. Cargue su archivo de curso (texto, PDF, Word)",
      examDateLabel: "Fecha del examen:",
      chooseFileLabel: "Seleccione un archivo de curso:",
      createBtn: "Crear fichas y planificación",
      fileEmpty: "Debe seleccionar un archivo de curso en formato texto (.txt), PDF o Word (.docx).",
      dateEmpty: "Debe introducir la fecha de su examen.",
      fileErrorType: "Formato de archivo no compatible. Use texto (.txt), PDF o Word (.docx).",
      fileReadError: "Error al leer el archivo.",
      flashcardsTitle: "Fichas de repaso",
      planningTitle: "Planificación de estudio",
      quizTitle: "Quiz para mejorar tu aprendizaje",
      cardsNotEnough: "El archivo no contiene suficiente contenido para crear fichas.",
      planDatePast: "La fecha del examen es anterior o igual a hoy.",
      flippedBack: "Ver más en el curso.",
      quizCorrect: "¡Correcto!",
      quizWrong: "Incorrecto. La respuesta correcta era:",
      progressLabel: "Progreso del quiz"
    },
    la: {
      step1: "1. Datam examinationis tui indica",
      step2: "2. Lima librum cursum tuum (textus, PDF, Verbum)",
      examDateLabel: "Examinationis dies:",
      chooseFileLabel: "Elige librum cursus:",
      createBtn: "Fac schedas et consilium",
      fileEmpty: "Debes eligere librum textum (.txt), PDF aut Verbum (.docx).",
      dateEmpty: "Debes inserere diem examinationis tui.",
      fileErrorType: "Forma librum non sufficit. Utere textu (.txt), PDF, aut Verbum (.docx).",
      fileReadError: "Error dum librum legit.",
      flashcardsTitle: "Schedas revisionis",
      planningTitle: "Consilium studii",
      quizTitle: "Quizzes ad meliorandam discendi rationem",
      cardsNotEnough: "Librum non habet satis contentum ad schedas creandas.",
      planDatePast: "Dies examinationis praeademvel hodie est.",
      flippedBack: "Vide plura incurso.",
      quizCorrect: "Recte!",
      quizWrong: "Falsum. Recta responsio erat:",
      progressLabel: "Progressus quiz"
    }
  };

  let currentLang = 'fr';

  // Store core app data
  let flashcards = [];
  let currentQuizIndex = -1;
  let examDate = null;

  // Track quiz progress stats
  let totalQuizQuestionsAsked = 0;
  let totalQuizQuestionsCorrect = 0;

  // Elements refs
  const examDateInput = document.getElementById('exam-date');
  const courseFileInput = document.getElementById('course-file');
  const processBtn = document.getElementById('process-course-btn');
  const fileFeedback = document.getElementById('file-feedback');
  const flashcardsSection = document.getElementById('revision-cards-section');
  const flashcardsContainer = document.getElementById('flashcards-container');
  const planningSection = document.getElementById('planning-section');
  const planningContainer = document.getElementById('planning-container');
  const quizSection = document.getElementById('quiz-section');
  const quizQuestionEl = document.getElementById('quiz-question');
  const quizOptionsEl = document.getElementById('quiz-options');
  const submitQuizBtn = document.getElementById('submit-quiz');
  const quizResultEl = document.getElementById('quiz-result');
  const langSelector = document.getElementById('language-selector');
  const progressRingCircle = document.querySelector('.progress-ring__circle');
  const progressPercentText = document.getElementById('progress-percent');

  const radius = progressRingCircle.r.baseVal.value;
  const circumference = 2 * Math.PI * radius;
  progressRingCircle.style.strokeDasharray = `${circumference} ${circumference}`;
  progressRingCircle.style.strokeDashoffset = circumference;

  function setProgress(percent) {
    const offset = circumference - (percent / 100 * circumference);
    progressRingCircle.style.strokeDashoffset = offset;
    progressPercentText.textContent = `${percent}%`;
  }

  // Text update for language
  function updateTextsForLanguage(lang) {
    document.getElementById('heading1').textContent = i18n[lang].step1;
    document.getElementById('heading2').textContent = i18n[lang].step2;
    document.getElementById('labelExamDate').textContent = i18n[lang].examDateLabel;
    document.getElementById('labelFile').textContent = i18n[lang].chooseFileLabel;
    processBtn.textContent = i18n[lang].createBtn;
    document.getElementById('headingFlashcards').textContent = i18n[lang].flashcardsTitle;
    document.getElementById('headingPlanning').textContent = i18n[lang].planningTitle;
    document.getElementById('headingQuiz').textContent = i18n[lang].quizTitle;
  }

  // Language switch event
  langSelector.addEventListener('change', (e) => {
    currentLang = e.target.value;
    updateTextsForLanguage(currentLang);
    fileFeedback.textContent = '';
    quizResultEl.textContent = '';
  });

  updateTextsForLanguage(currentLang);

  // Utility: Split text into flashcards adapting to exam delay. More days = more cards
  function createFlashcardsFromText(text, examDate) {
    const paragraphs = text.split(/\r?\n\r?\n/).map(p => p.trim()).filter(p => p.length > 10);
    const maxTotalCards = paragraphs.length;

    const now = new Date();
    const exam = new Date(examDate);
    let diffMs = exam - now;
    if(diffMs < 0) diffMs = 0;
    const diffDays = Math.floor(diffMs / (1000*60*60*24));
    // Map days left to max number of flashcards between 3 and paragraphs.length
    let cardsCount = 3;
    if(diffDays >= 30) cardsCount = Math.min(maxTotalCards, 10);
    else if(diffDays > 0) cardsCount = Math.min(maxTotalCards, Math.max(3, Math.floor((diffDays/30)*maxTotalCards)));
    else cardsCount = 3;

    let cards = [];
    for (let i = 0; i < cardsCount; i++) {
      let para = paragraphs[i];
      let splitIndex = para.indexOf('.') + 1;
      if (splitIndex <= 1) splitIndex = Math.min(para.length, 50);
      const front = para.slice(0, splitIndex).trim();
      const back = para.slice(splitIndex).trim() || i18n[currentLang].flippedBack;
      cards.push({ front, back });
    }
    return cards;
  }

  // Study plan generation
  function createStudyPlan(examDate, flashcardsCount) {
    const now = new Date();
    const exam = new Date(examDate);
    const diffMs = exam - now;
    if (diffMs <= 0) return { error: i18n[currentLang].planDatePast };
    const diffDays = Math.floor(diffMs / (1000*60*60*24));
    let days = diffDays;
    if (days > 30) days = 30; // cap at 30 days

    const dailyCount = Math.max(1, Math.ceil(flashcardsCount / days));
    let planLines = [];
    for (let i = 0; i < days; i++) {
      const dayDate = new Date(now.getTime());
      dayDate.setDate(now.getDate() + i + 1);
      const dayLabel = dayDate.toLocaleDateString(currentLang === 'fr' ? 'fr-FR' : currentLang, { weekday: 'short', day: 'numeric', month: 'short' });
      planLines.push(`${dayLabel} : ${i18n[currentLang].createBtn.includes('Créer') ? 'Étudier' : 'Study'} ${dailyCount} ${dailyCount > 1 ? 'fiches' : 'fiche'}`);
    }
    return { days, planLines };
  }

  // Rendering flashcards
  function renderFlashcards(cards) {
    flashcardsContainer.innerHTML = '';
    cards.forEach((card, i) => {
      const cardEl = document.createElement('div');
      cardEl.classList.add('card');
      cardEl.tabIndex = 0;
      const frontEl = document.createElement('div');
      frontEl.className = 'front';
      frontEl.textContent = card.front;
      const backEl = document.createElement('div');
      backEl.className = 'back';
      backEl.textContent = card.back;
      cardEl.appendChild(frontEl);
      cardEl.appendChild(backEl);
      cardEl.addEventListener('click', () => cardEl.classList.toggle('flipped'));
      cardEl.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          cardEl.classList.toggle('flipped');
        }
      });
      flashcardsContainer.appendChild(cardEl);
    });
  }

  // Render study plan list
  function renderPlanning(planLines) {
    planningContainer.innerHTML = '';
    const ul = document.createElement('ul');
    planLines.forEach(line => {
      const li = document.createElement('li');
      li.textContent = line;
      ul.appendChild(li);
    });
    planningContainer.appendChild(ul);
  }

  // Quiz data & logic
  function generateQuizQuestions(cards) {
    // Shuffle cards and question set
    const shuffled = cards.slice().sort(() => Math.random() - 0.5);
    return shuffled;
  }

  function renderQuizQuestion(card) {
    quizQuestionEl.textContent = card.front;
    quizOptionsEl.innerHTML = '';
    // Prepare options: correct answer + up to 3 random others or dummy if none
    const allAnswers = flashcards.map(c => c.back);
    let optionsSet = new Set();
    optionsSet.add(card.back);
    while (optionsSet.size < 4 && optionsSet.size < flashcards.length) {
      const randomBack = allAnswers[Math.floor(Math.random() * allAnswers.length)];
      optionsSet.add(randomBack);
    }
    let options = Array.from(optionsSet);
    options = options.sort(() => Math.random() - 0.5);

    options.forEach((opt, idx) => {
      const li = document.createElement('li');
      const label = document.createElement('label');
      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'quiz-option';
      input.value = opt;
      if(idx === 0) input.checked = true;
      label.appendChild(input);
      label.appendChild(document.createTextNode(opt));
      li.appendChild(label);
      quizOptionsEl.appendChild(li);
    });
    quizResultEl.textContent = '';
  }

  // Variables to hold current quiz questions and index
  let quizQuestions = [];
  let currentQuizQuestionIndex = 0;

  function loadNextQuizQuestion() {
    if (currentQuizQuestionIndex >= quizQuestions.length) {
      quizSection.hidden = true;
      alert(i18n[currentLang].progressLabel + ` : ${totalQuizQuestionsCorrect}/${totalQuizQuestionsAsked}`);
      return;
    }
    const card = quizQuestions[currentQuizQuestionIndex];
    renderQuizQuestion(card);
    setProgress(totalQuizQuestionsAsked === 0 ? 0 : Math.round(100 * (totalQuizQuestionsCorrect / totalQuizQuestionsAsked)));
  }

  submitQuizBtn.addEventListener('click', () => {
    const selectedInput = quizOptionsEl.querySelector('input[name="quiz-option"]:checked');
    if (!selectedInput) return;
    const answer = selectedInput.value;
    const correctAnswer = quizQuestions[currentQuizQuestionIndex].back;
    totalQuizQuestionsAsked++;
    if(answer === correctAnswer) {
      totalQuizQuestionsCorrect++;
      quizResultEl.style.color = '#34d399'; // green
      quizResultEl.textContent = i18n[currentLang].quizCorrect;
    } else {
      quizResultEl.style.color = '#f87171'; // red
      quizResultEl.textContent = `${i18n[currentLang].quizWrong} "${correctAnswer}"`;
    }
    setProgress(Math.round(100 * (totalQuizQuestionsCorrect / totalQuizQuestionsAsked)));
    currentQuizQuestionIndex++;
    setTimeout(() => {
      if(currentQuizQuestionIndex < quizQuestions.length) {
        loadNextQuizQuestion();
      } else {
        quizResultEl.textContent = '';
        quizSection.hidden = true;
        alert(`${i18n[currentLang].progressLabel}: ${totalQuizQuestionsCorrect} / ${totalQuizQuestionsAsked}`);
      }
    }, 1800);
  });

  // File reading helpers
  async function readPdfAsText(file) {
    const typedarray = new Uint8Array(await file.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;
    let fullText = '';
    for(let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str);
      fullText += strings.join(' ') + '\n\n';
    }
    return fullText;
  }

  async function readDocxAsText(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = function(event) {
        const arrayBuffer = reader.result;
        mammoth.extractRawText({arrayBuffer: arrayBuffer})
          .then(function(result){
            resolve(result.value);
          })
          .catch(reject);
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // Main process button
  processBtn.addEventListener('click', async () => {
    fileFeedback.textContent = '';
    quizResultEl.textContent = '';
    quizSection.hidden = true;
    flashcardsSection.hidden = true;
    planningSection.hidden = true;
    flashcardsContainer.innerHTML = '';
    planningContainer.innerHTML = '';
    totalQuizQuestionsAsked = 0;
    totalQuizQuestionsCorrect = 0;
    currentQuizQuestionIndex = 0;
    setProgress(0);

    const dateVal = examDateInput.value;
    if (!dateVal) {
      fileFeedback.textContent = i18n[currentLang].dateEmpty;
      return;
    }
    examDate = dateVal;

    if (!courseFileInput.files.length) {
      fileFeedback.textContent = i18n[currentLang].fileEmpty;
      return;
    }

    const file = courseFileInput.files[0];
    const ext = file.name.split('.').pop().toLowerCase();

    let textContent = '';
    try {
      if(ext === 'txt') {
        textContent = await file.text();
      } else if(ext === 'pdf') {
        textContent = await readPdfAsText(file);
      } else if(ext === 'docx') {
        textContent = await readDocxAsText(file);
      } else {
        fileFeedback.textContent = i18n[currentLang].fileErrorType;
        return;
      }
    } catch(e) {
      fileFeedback.textContent = i18n[currentLang].fileReadError;
      return;
    }

    flashcards = createFlashcardsFromText(textContent, examDate);
    if (flashcards.length < 1) {
      fileFeedback.textContent = i18n[currentLang].cardsNotEnough;
      return;
    }

    renderFlashcards(flashcards);
    flashcardsSection.hidden = false;

    const plan = createStudyPlan(examDate, flashcards.length);
    if(plan.error) {
      fileFeedback.textContent = plan.error;
      planningSection.hidden = true;
    } else {
      renderPlanning(plan.planLines);
      planningSection.hidden = false;
    }

    quizQuestions = generateQuizQuestions(flashcards);
    currentQuizQuestionIndex = 0;
    totalQuizQuestionsAsked = 0;
    totalQuizQuestionsCorrect = 0;
    quizSection.hidden = false;
    loadNextQuizQuestion();

    fileFeedback.textContent = i18n[currentLang].createBtn + ' - ' + flashcards.length + ' ' + (flashcards.length > 1 ? 'fiches générées.' : 'fiche générée.');
  });

})();
</script>
</body>
</html>

